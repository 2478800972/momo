<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¾å…‰çµ®è¯­ | å¤šåŠŸèƒ½æ–‡è‰ºèŠå¤©å®¤</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Noto Serif SC", serif;
            letter-spacing: 0.3px;
        }

        body {
            background-color: #f5f7fa;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3.414 1.414a2 2 0 112.828 0L10 6.586a2 2 0 11-2.828 2.828L3.414 4.242a2 2 0 010-2.828z' fill='%23d8dce3' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
            min-height: 100vh;
            padding: 2vw;
        }

        .chat-container {
            width: 90%;
            max-width: 780px;
            margin: 2vw auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            overflow: hidden;
            border: 1px solid rgba(224, 228, 235, 0.5);
        }

        /* å¤´éƒ¨+åŠŸèƒ½èœå• */
        .chat-header {
            background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%);
            color: #fff;
            padding: 1vw 1.5vw;
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            position: relative;
        }
        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-title {
            font-family: "Ma Shan Zheng", cursive;
            font-weight: 400;
            font-size: clamp(1.5rem, 3vw, 24px);
            text-shadow: 1px 1px 2px rgba(100, 116, 139, 0.2);
            letter-spacing: 3px;
        }
        /* åŠŸèƒ½èœå•æŒ‰é’® */
        .menu-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: clamp(12px, 1.5vw, 14px);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.3s ease;
        }
        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .function-menu {
            position: absolute;
            top: 100%;
            right: 1.5vw;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(165, 177, 194, 0.2);
            width: 220px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        .menu-category {
            padding: 8px 12px;
            background: #f1f5f9;
            color: #60a5fa;
            font-size: 13px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }
        .menu-item {
            padding: 10px 16px;
            color: #334155;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .menu-item:hover {
            background: #f8fafc;
        }
        .menu-item.active {
            background: #e6f0f5;
            color: #1e40af;
        }
        .menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 2px 0;
        }

        .chat-messages {
            height: clamp(300px, 55vh, 480px);
            padding: 2vw;
            overflow-y: auto;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h20v20H0V0zm2 2v16h16V2H2z' fill='%23e2e8f0' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .chat-messages::-webkit-scrollbar {
            width: 5px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.3);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
            transition: background 0.3s ease;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #7c8ba1;
        }

        .system-message {
            text-align: center;
            margin: 1.5vw 0;
            font-size: clamp(12px, 1.5vw, 13px);
            color: #7c8ba1;
        }
        .system-message span {
            background: rgba(226, 232, 240, 0.4);
            padding: 6px 16px;
            border-radius: 18px;
            border: 1px dashed rgba(148, 163, 184, 0.3);
            font-style: italic;
            letter-spacing: 0.5px;
        }

        .message {
            margin-bottom: 1.5vw;
            max-width: 72%;
            line-height: 1.7;
            transition: opacity 0.4s ease, transform 0.4s ease;
            opacity: 0;
            transform: translateY(10px) scale(0.98);
        }
        .message.left {
            margin-right: auto;
        }
        .message.right {
            margin-left: auto;
        }
        .message.show {
            opacity: 1;
            transform: translate(0, 0) scale(1);
        }

        .message-content {
            padding: clamp(12px, 2vw, 14px) clamp(18px, 2.5vw, 20px);
            border-radius: 20px;
            position: relative;
            box-shadow: 0 2px 8px rgba(165, 177, 194, 0.1);
            font-size: clamp(14px, 2vw, 15px);
            color: #334155;
        }

        .right .message-content {
            background: linear-gradient(145deg, #e4eaf5 0%, #d1d9e6 100%);
            border-bottom-right-radius: 5px;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='10' viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h10v10H0V0zm1 1v8h8V1H1z' fill='%23ffffff' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .left .message-content {
            background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
            border-bottom-left-radius: 5px;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='10' viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h10v10H0V0zm1 1v8h8V1H1z' fill='%23ffffff' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* 1. Pixivå›¾ç‰‡æœç´¢æ ·å¼ */
        .pixiv-container {
            margin: 10px 0;
        }
        .pixiv-title {
            font-size: clamp(13px, 1.8vw, 14px);
            color: #60a5fa;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .pixiv-img {
            width: 100%;
            max-width: 90%;
            margin: 0 auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(165, 177, 194, 0.15);
            border: 1px solid rgba(224, 228, 235, 0.6);
        }
        .pixiv-tags {
            font-size: clamp(12px, 1.5vw, 13px);
            color: #7c8ba1;
            text-align: center;
            margin-top: 8px;
            line-height: 1.5;
        }

        /* 2. æŠ•æ·åœ£æ¯æ ·å¼ */
        .shengbei-process {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(241, 245, 249, 0.6);
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
        }
        .shengbei-result {
            font-weight: 500;
            color: #1e40af;
            text-align: center;
            margin: 8px 0;
            font-size: 15px;
        }
        .shengbei-poem {
            font-style: italic;
            color: #60a5fa;
            text-align: center;
            line-height: 1.8;
            margin: 8px 0;
            padding: 8px;
            border-left: 2px solid #60a5fa;
        }

        /* 3. è¿åŠ¿çµç­¾æ ·å¼ */
        .lingqian-img {
            width: 100%;
            max-width: 80%;
            margin: 10px auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(165, 177, 194, 0.15);
        }
        .lingqian-text {
            line-height: 1.8;
            margin: 8px 0;
        }
        .lingqian-sign {
            color: #1e40af;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .lingqian-explain {
            margin-top: 8px;
            font-size: 14px;
            color: #334155;
        }

        /* 4. å¡”ç½—ç‰Œæ ·å¼ */
        .taluo-container {
            text-align: center;
            margin: 10px 0;
        }
        .taluo-img {
            width: 100%;
            max-width: 70%;
            margin: 0 auto;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(165, 177, 194, 0.15);
            border: 1px solid rgba(224, 228, 235, 0.6);
        }
        .taluo-name {
            font-size: 15px;
            color: #1e40af;
            margin: 8px 0;
            letter-spacing: 0.5px;
        }
        .taluo-keyword {
            font-size: 13px;
            color: #60a5fa;
            margin-bottom: 8px;
            font-style: italic;
        }
        .taluo-moral {
            line-height: 1.7;
            font-size: 14px;
            text-align: left;
            padding: 8px 12px;
            background: rgba(241, 245, 249, 0.6);
            border-radius: 8px;
        }

        /* åŸæœ‰åŠŸèƒ½æ ·å¼ä¿ç•™ */
        .day-sign-img {
            width: 100%;
            max-width: 80%;
            margin: 10px auto;
            display: block;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(165, 177, 194, 0.15);
            border: 1px solid rgba(224, 228, 235, 0.6);
        }
        .day-sign-tip {
            text-align: center;
            margin-bottom: 8px;
            color: #60a5fa;
            font-size: clamp(13px, 1.8vw, 14px);
            font-style: italic;
        }
        .quote-header {
            text-align: center;
            margin-bottom: 10px;
            color: #60a5fa;
            font-size: clamp(13px, 1.8vw, 14px);
            font-style: italic;
            letter-spacing: 1px;
        }
        .quote-content {
            line-height: 1.8;
            padding: 8px 12px;
            background: rgba(241, 245, 249, 0.6);
            border-radius: 8px;
            border-left: 2px solid #60a5fa;
            margin: 5px 0;
        }
        .quote-tip {
            text-align: center;
            margin-top: 8px;
            font-size: clamp(12px, 1.5vw, 13px);
            color: #7c8ba1;
        }
        .weather-message .message-content {
            background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
            border-left: 3px solid #60a5fa;
            color: #334155;
            padding: clamp(14px, 2.2vw, 16px) clamp(20px, 2.8vw, 22px);
        }
        .weather-item {
            display: block;
            margin: clamp(6px, 1.2vw, 8px) 0;
            font-size: clamp(13px, 1.8vw, 14px);
            line-height: 1.6;
        }
        .weather-item.api-key {
            font-weight: 500;
            color: #1e40af;
            padding-left: 4px;
            border-left: 2px solid #60a5fa;
        }
        .weather-item.api-aux {
            color: #334155;
            opacity: 1;
        }
        .weather-item span {
            font-weight: 500;
            color: #60a5fa;
            width: clamp(75px, 10vw, 85px);
            display: inline-block;
            letter-spacing: 0.8px;
        }
        .weather-item i {
            margin-right: 7px;
            font-size: clamp(14px, 1.8vw, 15px);
            vertical-align: middle;
            color: #60a5fa;
        }
        .weather-header {
            margin-bottom: clamp(6px, 1.2vw, 8px);
            font-size: clamp(15px, 2vw, 16px);
            color: #60a5fa;
            font-weight: 300;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        .weather-header .weather-icon {
            margin-right: clamp(6px, 1vw, 8px);
            font-size: clamp(16px, 2.2vw, 18px);
        }

        .message-time {
            font-size: clamp(10px, 1.2vw, 11px);
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
            font-style: italic;
            letter-spacing: 0;
            color: #7c8ba1;
        }
        .left .message-time {
            padding-left: 16px;
        }
        .right .message-time {
            padding-right: 16px;
        }
        .message-meta {
            font-size: clamp(9px, 1vw, 10px);
            margin-top: 2px;
            opacity: 0;
            text-align: right;
            font-style: italic;
            transition: opacity 0.6s ease 0.2s;
            color: #7c8ba1;
        }
        .message.show .message-meta {
            opacity: 0.5;
        }

        /* è¾“å…¥åŒº+åŠŸèƒ½è§¦å‘æç¤º */
        .chat-input-area {
            padding: 1vw 1.5vw;
            border-top: 1px solid rgba(224, 228, 235, 0.6);
            background: rgba(255, 255, 255, 0.98);
        }
        .input-tip {
            font-size: clamp(11px, 1.2vw, 12px);
            color: #a5b4c7;
            margin-bottom: 10px;
            text-align: left;
            letter-spacing: 0.3px;
        }
        .chat-input {
            display: flex;
            gap: 12px;
        }
        #message-input {
            flex: 1;
            padding: clamp(12px, 1.8vw, 14px) clamp(18px, 2.2vw, 20px);
            border: 1px solid #e2e8f0;
            border-radius: 28px;
            outline: none;
            font-size: clamp(14px, 2vw, 15px);
            color: #334155;
            background: rgba(248, 250, 252, 0.8);
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(165, 177, 194, 0.05);
        }
        #message-input:focus {
            border-color: #94a3b8;
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.15), inset 0 1px 3px rgba(165, 177, 194, 0.05);
            background: #fff;
        }
        #message-input::placeholder {
            color: #a5b4c7;
            font-style: italic;
            letter-spacing: 0.5px;
        }

        #send-btn {
            padding: clamp(12px, 1.8vw, 14px) clamp(22px, 2.5vw, 28px);
            border: none;
            border-radius: 28px;
            background: linear-gradient(145deg, #6a85b6 0%, #8a9fc2 100%);
            color: #fff;
            font-family: "Ma Shan Zheng", cursive;
            font-size: clamp(14px, 2vw, 15px);
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            white-space: nowrap;
        }
        #send-btn:hover {
            background: linear-gradient(145deg, #5a75a6 0%, #7a8fba 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(106, 133, 182, 0.3);
        }
        #send-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(106, 133, 182, 0.2);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: clamp(8px, 1.5vw, 10px) clamp(12px, 2vw, 16px);
            background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            width: fit-content;
            box-shadow: 0 2px 8px rgba(165, 177, 194, 0.1);
        }
        .typing-indicator span {
            width: clamp(8px, 1.2vw, 9px);
            height: clamp(8px, 1.2vw, 9px);
            border-radius: 50%;
            background: #94a3b8;
            animation: typing 1.5s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 0.8; }
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .message {
                max-width: 85%;
            }
            .function-menu {
                width: 180px;
                right: 1vw;
            }
            .menu-item {
                padding: 8px 12px;
                font-size: 13px;
            }
            .pixiv-img, .taluo-img, .lingqian-img, .day-sign-img {
                max-width: 95%;
            }
            .weather-item span {
                width: 65px;
            }
            .chat-input {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- å¤´éƒ¨+åŠŸèƒ½èœå• -->
        <div class="chat-header">
            <div class="header-inner">
                <div class="chat-title">æ‹¾å…‰çµ®è¯­</div>
                <button class="menu-btn" id="menu-btn">
                    <span>åŠŸèƒ½èœå•</span>
                    <span>â–¼</span>
                </button>
            </div>
            <!-- åŠŸèƒ½èœå•ä¸‹æ‹‰æ¡† -->
            <div class="function-menu" id="function-menu">
                <div class="menu-category">æ—¥å¸¸äº’åŠ¨</div>
                <div class="menu-item" data-function="chat">èŠå¤©å¯¹è¯</div>
                <div class="menu-item" data-function="weather">å¤©æ°”æŸ¥è¯¢</div>
                <div class="menu-divider"></div>
                <div class="menu-category">æ–‡è‰ºå†…å®¹</div>
                <div class="menu-item" data-function="day-sign">ä»Šæ—¥æ—¥ç­¾</div>
                <div class="menu-item" data-function="quote">èšåˆè¯­å½•</div>
                <div class="menu-item" data-function="pixiv">Pixivå›¾ç‰‡æœç´¢</div>
                <div class="menu-divider"></div>
                <div class="menu-category">è¿åŠ¿å åœ</div>
                <div class="menu-item" data-function="shengbei">æŠ•æ·åœ£æ¯</div>
                <div class="menu-item" data-function="lingqian">è¿åŠ¿çµç­¾</div>
                <div class="menu-item" data-function="taluo">å¡”ç½—ç‰Œå åœ</div>
            </div>
        </div>

        <!-- æ¶ˆæ¯åŒº -->
        <div class="chat-messages" id="chat-messages">
            <div class="system-message">
                <span>äºŒé›¶äºŒäº”å¹´æ˜¥ Â· æˆ‘ä»¬åœ¨æ­¤ç›¸é‡</span>
            </div>
            <div class="message left show">
                <div class="message-content">
                    ä½ å¥½å‘€ï½ ç‚¹å‡»å³ä¸Šè§’ã€ŒåŠŸèƒ½èœå•ã€å¯å¿«é€Ÿä½¿ç”¨åŠŸèƒ½ï¼Œä¹Ÿèƒ½è¾“å…¥å…³é”®è¯ï¼ˆä¾‹ï¼šæŸ¥åŒ—äº¬å¤©æ°”/è¦æ¯’é¸¡æ±¤/æ·åœ£æ¯ï¼‰
                </div>
                <div class="message-time">14:25</div>
                <div class="message-meta">çµ®è¯­38å­— Â· å¿ƒæ„6å­—</div>
            </div>
        </div>

        <!-- è¾“å…¥åŒº -->
        <div class="chat-input-area">
            <div class="input-tip">æç¤ºï¼šè¾“å…¥â€œæœPixiv+å…³é”®è¯â€â€œæŠ½çµç­¾â€â€œæŠ½å¡”ç½—ç‰Œâ€ç­‰å¯å¿«é€Ÿè§¦å‘åŠŸèƒ½</div>
            <div class="chat-input">
                <input type="text" id="message-input" placeholder="èŠå¤©ã€æŸ¥å¤©æ°”ï¼ˆåŒ—äº¬å¤©æ°”ï¼‰ã€è¦è¯­å½•ï¼ˆæ¯’é¸¡æ±¤ï¼‰ï¼Œæˆ–ç”¨åŠŸèƒ½èœå•...">
                <button id="send-btn">é€ä¿¡</button>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const menuBtn = document.getElementById('menu-btn');
        const functionMenu = document.getElementById('function-menu');
        const menuItems = document.querySelectorAll('.menu-item');

        // æ¥å£é…ç½®ï¼ˆæ–°å¢4ä¸ªAPI+åŸæœ‰APIï¼‰
        const API_CONFIG = {
            pixiv: "http://ranyu.sbs/API/pz.php",        // Pixivå›¾ç‰‡æœç´¢
            shengbei: "http://ranyu.sbs/API/shengbei.php", // æŠ•æ·åœ£æ¯
            lingqian: "http://ranyu.sbs/API/lingqian.php", // è¿åŠ¿çµç­¾
            taluo: "http://ranyu.sbs/API/taluo.php",     // å¡”ç½—ç‰Œ
            daySign: "http://api.xingchenfu.xyz/API/day.php", // æ—¥ç­¾
            weather: "https://api.icofun.cn/api/xztq.php", // å¤©æ°”
            quote: "https://api.icofun.cn/api/zpai.php"    // èšåˆè¯­å½•
        };
        const IMG_TEXT_TO_REMOVE = "Â±img=https://s1.sencdn.com/web/icons/black/[0-9]+@1x.pngÂ±";
        let currentFunction = null; // å½“å‰é€‰ä¸­åŠŸèƒ½

        // åŸºç¡€å·¥å…·å‡½æ•°
        function getTimeContext() {
            const hour = new Date().getHours();
            const contexts = [
                [6,10,"æ™¨é›¾è½»è½»æ¼«è¿‡çª—æ²¿æ—¶"],
                [10,12,"é˜³å…‰æ‚„æ‚„è·³ä¸Šæ¡Œé¢æ—¶"],
                [12,15,"é£æºç€æš–æ„æ‹‚è¿‡è‚©å¤´æ—¶"],
                [15,18,"æ™šéœæŠŠå¤©é™…æŸ“æˆç²‰æ©˜è‰²æ—¶"],
                [18,21,"ç¯å½±æ…¢æ…¢æ¼«è¿‡è¡—è§’æ—¶"],
                [21,24,"æ˜Ÿå­ç¼€æ»¡å¢¨è‰²å¤œç©ºæ—¶"],
                [0,6,"æœˆè‰²é™é™æµ¸ç€æˆ¿é—´æ—¶"]
            ];
            return contexts.find(([s, e, ctx]) => hour >= s && hour < e)[2];
        }

        function showTyping() {
            const typingEl = document.createElement("div");
            typingEl.className = "message left typing-indicator";
            typingEl.innerHTML = "<span></span><span></span><span></span>";
            chatMessages.appendChild(typingEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingEl;
        }

        function showMessage(content, isLeft = true, meta = "æ¶ˆæ¯") {
            const timeStr = new Date().toTimeString().slice(0, 5);
            const msgEl = document.createElement("div");
            msgEl.className = `message ${isLeft ? "left" : "right"}`;
            msgEl.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${timeStr}</div>
                <div class="message-meta">${meta}</div>
            `;
            chatMessages.appendChild(msgEl);
            setTimeout(() => msgEl.classList.add("show"), 50);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return msgEl;
        }

        // --------------------------
        // 1. æ–°å¢ï¼šPixivå›¾ç‰‡æœç´¢ï¼ˆAPI id=35ï¼‰
        // --------------------------
        function parsePixivQuery(userMsg) {
            const match = userMsg.match(/æœPixiv([^ï¼Œã€‚\s]+)/);
            return match ? match[1].trim() : null;
        }

        async function fetchPixiv(keyword) {
            if (!keyword) {
                return `
                    <div class="pixiv-title">${getTimeContext()} Â· Pixivæœç´¢æç¤º</div>
                    <div style="text-align:center; margin-top:8px;">è¯·å‘Šè¯‰æˆ‘è¦æœç´¢çš„å…³é”®è¯å“¦ï½ ä¾‹ï¼šæœPixivå¤©æ°”ä¹‹å­</div>
                `;
            }

            try {
                const params = new URLSearchParams({ q: keyword, type: "all" });
                const res = await fetch(`${API_CONFIG.pixiv}?${params.toString()}`);
                const data = await res.json();

                if (data.code !== "200" || !data.data || data.data.length === 0) {
                    throw new Error("æ²¡æ‰¾åˆ°ç›¸å…³å›¾ç‰‡ï¼Œæ¢ä¸ªå…³é”®è¯è¯•è¯•å§ï½");
                }

                const firstImg = data.data[0];
                return `
                    <div class="pixiv-container">
                        <div class="pixiv-title">${getTimeContext()} Â· Pixivæœç´¢ç»“æœï¼ˆ${keyword}ï¼‰</div>
                        <img src="${firstImg.img2 || firstImg.img1}" class="pixiv-img" 
                             alt="${firstImg.title}"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzgwODA4MCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHRleHQ9Ik1JR04g5Zu+5Lq65paw5pyN5Yqh54K5Ii8+PC9zdmc+'">
                        <div class="pixiv-tags">æ ‡é¢˜ï¼š${firstImg.title || "æœªå‘½å"} | æ ‡ç­¾ï¼š${firstImg.tags || "æ— "}</div>
                    </div>
                `;
            } catch (err) {
                return `
                    <div class="pixiv-title">${getTimeContext()} Â· Pixivæœç´¢æç¤º</div>
                    <div style="text-align:center; margin-top:8px;">${err.message}</div>
                `;
            }
        }

        // --------------------------
        // 2. æ–°å¢ï¼šæŠ•æ·åœ£æ¯ï¼ˆAPI id=40ï¼‰
        // --------------------------
        async function fetchShengbei() {
            try {
                const res = await fetch(API_CONFIG.shengbei);
                const data = await res.json();

                if (data.code !== "200") {
                    throw new Error("åœ£æ¯æŠ•æ·å¤±è´¥ï¼Œç¨ç­‰å†è¯•å§ï½");
                }

                return `
                    <div class="shengbei-process">
                        ${getTimeContext()} Â· åœ£æ¯æŠ•æ·è¿‡ç¨‹ï¼š<br>
                        ${data.process.map((step, idx) => `${idx+1}. ${step}`).join("<br>")}
                    </div>
                    <div class="shengbei-result">æŠ•æ·ç»“æœï¼š${data.result}</div>
                    <div class="shengbei-poem">ç­¾è¯—ï¼š${data.poem || "æ— "}</div>
                    <div style="text-align:center; font-size:13px; color:#7c8ba1;">
                        è§£æ›°ï¼š${data.content || "æš‚æ— è§£ç­¾å†…å®¹"}
                    </div>
                `;
            } catch (err) {
                return `
                    <div class="shengbei-result">${getTimeContext()} Â· åœ£æ¯æç¤º</div>
                    <div style="text-align:center; margin-top:8px;">${err.message}</div>
                `;
            }
        }

        // --------------------------
        // 3. æ–°å¢ï¼šè¿åŠ¿çµç­¾ï¼ˆAPI id=14ï¼‰
        // --------------------------
        async function fetchLingqian() {
            try {
                // å…ˆå°è¯•è·å–å›¾ç‰‡æ ¼å¼ï¼Œå¤±è´¥åˆ™ç”¨æ–‡æœ¬
                let res = await fetch(`${API_CONFIG.lingqian}?type=img`);
                if (res.ok && res.headers.get("content-type").includes("image")) {
                    const blob = await res.blob();
                    const imgUrl = URL.createObjectURL(blob);
                    return `
                        <div class="lingqian-title">${getTimeContext()} Â· ä»Šæ—¥çµç­¾</div>
                        <img src="${imgUrl}" class="lingqian-img" alt="è¿åŠ¿çµç­¾"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzgwODA4MCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHRleHQ9Iui9veWbvSIsIHN0cm9rZT0iIzYwYTVmYSIvPjwvc3ZnPg=='">
                    `;
                }

                // æ–‡æœ¬æ ¼å¼
                res = await fetch(API_CONFIG.lingqian);
                const text = await res.text();
                const signMatch = text.match(/ç¬¬\d+ç­¾ã€([^ã€‘]+)ã€‘/);
                const poemMatch = text.match(/ç­¾è¯—:(.+?)(è§£ç­¾:|$)/s);
                const explainMatch = text.match(/è§£ç­¾:(.+?)(è§£æ›°:|$)/s);
                const jieYueMatch = text.match(/è§£æ›°:(.+)/s);

                return `
                    <div class="lingqian-text">
                        <div class="lingqian-sign">${getTimeContext()} Â· è¿åŠ¿çµç­¾ ${signMatch ? signMatch[0] : ""}</div>
                        <div>ç­¾è¯—ï¼š${poemMatch ? poemMatch[1].trim() : "æ— "}</div>
                        <div class="lingqian-explain">è§£ç­¾ï¼š${explainMatch ? explainMatch[1].trim() : "æ— "}</div>
                        <div class="lingqian-explain">è§£æ›°ï¼š${jieYueMatch ? jieYueMatch[1].trim() : "æ— "}</div>
                    </div>
                `;
            } catch (err) {
                return `
                    <div class="lingqian-sign">${getTimeContext()} Â· çµç­¾æç¤º</div>
                    <div style="text-align:center; margin-top:8px;">çµç­¾è·å–å¤±è´¥ï¼Œç¨ç­‰å†è¯•å§ï½</div>
                `;
            }
        }

        // --------------------------
        // 4. æ–°å¢ï¼šå¡”ç½—ç‰Œï¼ˆAPI id=1ï¼‰
        // --------------------------
        async function fetchTaluo() {
            try {
                const res = await fetch(API_CONFIG.taluo);
                const data = await res.json();

                if (!data.name || !data.image) {
                    throw new Error("å¡”ç½—ç‰Œè·å–å¤±è´¥ï¼Œæ¢ä¸ªæ—¶é—´è¯•è¯•å§ï½");
                }

                return `
                    <div class="taluo-container">
                        <div class="taluo-name">${getTimeContext()} Â· å¡”ç½—ç‰Œï¼š${data.name}</div>
                        <img src="${data.image}" class="taluo-img" alt="${data.name}"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzgwODA4MCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHRleHQ9IlRhbHVvIFBhcmtpbmcg55S75Lq65paw5pyN5Yqh54K5Ii8+PC9zdmc+'">
                        <div class="taluo-keyword">å…³é”®è¯ï¼š${data.keyword || "æ— "}</div>
                        <div class="taluo-moral">å¯“æ„ï¼š${data.moral || "æš‚æ— å¯“æ„è§£é‡Š"}</div>
                    </div>
                `;
            } catch (err) {
                return `
                    <div class="taluo-name">${getTimeContext()} Â· å¡”ç½—ç‰Œæç¤º</div>
                    <div style="text-align:center; margin-top:8px;">${err.message}</div>
                `;
            }
        }

        // --------------------------
        // åŸæœ‰åŠŸèƒ½ä¿ç•™ï¼ˆæ—¥ç­¾/å¤©æ°”/èšåˆè¯­å½•ï¼‰
        // --------------------------
        async function fetchDaySign() {
            try {
                const res = await fetch(API_CONFIG.daySign);
                if (!res.ok) throw new Error("æ—¥ç­¾è·å–å¤±è´¥");
                const blob = await res.blob();
                const imgUrl = URL.createObjectURL(blob);
                return `
                    <div class="day-sign-tip">${getTimeContext()} ä»Šæ—¥æ—¥ç­¾</div>
                    <img src="${imgUrl}" class="day-sign-img" alt="ä»Šæ—¥æ—¥ç­¾"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzgwODA4MCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHRleHQ9IkfmmoLmmoLvvIwveiLseS6huiuseWbvSIsIHN0cm9rZT0iIzYwYTVmYSIvPjwvc3ZnPg=='">
                `;
            } catch (err) {
                return `
                    <div class="day-sign-tip">${getTimeContext()} æ—¥ç­¾æç¤º</div>
                    <div style="text-align:center; margin-top:8px;">æ—¥ç­¾æš‚æ—¶æ‹¿ä¸åˆ°ï¼Œæ¢ä¸ªæ—¶é—´è¯•è¯•å§ï½</div>
                `;
            }
        }

        async function fetchWeather(city) {
            if (!city) return `
                <div class="weather-header"><span class="weather-icon">âš ï¸</span>${getTimeContext()} å¤©æ°”æç¤º</div>
                <div class="weather-item api-aux"><span>è¯·è¾“å…¥åœ°å</span>ï¼š <<<i>ğŸ’¡</</</i> ä¾‹ï¼šåŒ—äº¬å¤©æ°”ã€ä¸Šæµ·å¤©æ°”</div>
            `;

            try {
                const params = new URLSearchParams({ msg: city, hh: "\n" });
                const res = await fetch(`${API_CONFIG.weather}?${params.toString()}`);
                let text = await res.text().replace(new RegExp(IMG_TEXT_TO_REMOVE, "g"), "").trim();
                if (!text) throw new Error("æ— å¤©æ°”æ•°æ®");

                const data = {};
                text.split("\n").forEach(line => {
                    const [k, v] = line.split("ï¼š").map(i => i.trim());
                    if (k && v) data[k] = v;
                });

                const weatherMap = { "æ™´":"â˜€ï¸", "å¤šäº‘":"â˜ï¸", "é˜´":"ğŸŒ¥ï¸", "é›¨":"ğŸŒ§ï¸", "é›ª":"â„ï¸" };
                const icon = weatherMap[data["å®æ—¶å¤©æ°”"]?.slice(0,1)] || "ğŸŒ¤ï¸";
                const temp = data["å®æ—¶æ°”æ¸©"] ? data["å®æ—¶æ°”æ¸©"].replace("Â°", "â„ƒ") : "æœªçŸ¥";

                return `
                    <div class="weather-header"><span class="weather-icon">${icon}</span>${getTimeContext()} ${data["åŸå¸‚å"] || city}å¤©æ°”</div>
                    <div class="weather-item api-key"><span>å®æ—¶å¤©æ°”</span>ï¼š <<<i>${icon}</</</i> ${data["å®æ—¶å¤©æ°”"] || "æœªçŸ¥"}</div>
                    <div class="weather-item api-key"><span>å®æ—¶æ°”æ¸©</span>ï¼š <<<i>ğŸŒ¡ï¸</</</i> ${temp}</div>
                    <div class="weather-item api-aux"><span>æ›´æ–°æ—¶é—´</span>ï¼š <<<i>â°</</</i> ${data["æ›´æ–°æ—¶é—´"] || "æœªçŸ¥"}</div>
                `;
            } catch (err) {
                return `
                    <div class="weather-header"><span class="weather-icon">âš ï¸</span>${getTimeContext()} å¤©æ°”æç¤º</div>
                    <div class="weather-item api-aux"><span>æŸ¥è¯¢åœ°å</span>ï¼š <<<i>ğŸ“</</</i> ${city}</div>
                    <div class="weather-item api-aux"><span>çŠ¶æ€</span>ï¼š <<<i>âŒ</</i> æš‚æœªè·å–åˆ°å¤©æ°”æ•°æ®</div>
                `;
            }
        }

        async function fetchQuote(type) {
            const quoteTypes = ["æ¯’é¸¡æ±¤", "æƒ…è¯", "ç¬‘è¯", "å®‰æ…°è¯­å½•"];
            const targetType = type || quoteTypes[Math.floor(Math.random() * quoteTypes.length)];
            try {
                const params = new URLSearchParams({ msg: targetType, type: "text" });
                const res = await fetch(`${API_CONFIG.quote}?${params.toString()}`);
                const text = await res.text().trim();
                return `
                    <div class="quote-header">${getTimeContext()} Â· ä»Šæ—¥ä»½${targetType}</div>
                    <div class="quote-content">${text || "æš‚æ— è¯­å½•å†…å®¹"}</div>
                    <div class="quote-tip">â€”â€” æ¥è‡ªèšåˆè¯­å½•</div>
                `;
            } catch (err) {
                return `
                    <div class="quote-header">${getTimeContext()} Â· è¯­å½•æç¤º</div>
                    <div class="quote-content" style="text-align:center;">${targetType}æš‚æ—¶æ‹¿ä¸åˆ°ï¼Œæ¢ä¸ªç±»å‹è¯•è¯•ï½</div>
                `;
            }
        }

        // --------------------------
        // åŠŸèƒ½è§¦å‘ä¸èœå•äº¤äº’
        // --------------------------
        // èœå•å±•å¼€/æ”¶èµ·
        menuBtn.addEventListener("click", () => {
            functionMenu.style.display = functionMenu.style.display === "block" ? "none" : "block";
        });

        // ç‚¹å‡»èœå•è§¦å‘åŠŸèƒ½
        menuItems.forEach(item => {
            item.addEventListener("click", () => {
                currentFunction = item.dataset.function;
                item.classList.add("active");
                setTimeout(() => item.classList.remove("active"), 300);
                functionMenu.style.display = "none";

                // ç‰¹æ®Šå¤„ç†éœ€è¦è¾“å…¥çš„åŠŸèƒ½ï¼ˆPixivï¼‰
                if (currentFunction === "pixiv") {
                    messageInput.placeholder = "è¯·è¾“å…¥Pixivæœç´¢å…³é”®è¯ï¼ˆä¾‹ï¼šå¤©æ°”ä¹‹å­ï¼‰...";
                    messageInput.focus();
                } else {
                    sendMessage();
                }
            });
        });

        // å…³é”®è¯è§£æ
        function parseUserInput(input) {
            input = input.trim();
            if (input.includes("Pixiv")) return { type: "pixiv", value: parsePixivQuery(input) };
            if (input.includes("åœ£æ¯")) return { type: "shengbei" };
            if (input.includes("çµç­¾")) return { type: "lingqian" };
            if (input.includes("å¡”ç½—")) return { type: "taluo" };
            if (input.includes("æ—¥ç­¾")) return { type: "daySign" };
            if (input.includes("å¤©æ°”")) return { type: "weather", value: input.replace(/å¤©æ°”|æŸ¥|çš„/g, "").trim() };
            if (["æ¯’é¸¡æ±¤", "æƒ…è¯", "ç¬‘è¯", "å®‰æ…°"].some(t => input.includes(t))) return { type: "quote", value: input };
            return { type: "chat", value: input };
        }

        // ç»Ÿä¸€å‘é€é€»è¾‘
        async function sendMessage() {
            const userInput = messageInput.value.trim() || "";
            const inputData = currentFunction ? { type: currentFunction, value: userInput } : parseUserInput(userInput);
            currentFunction = null;
            messageInput.value = "";
            messageInput.placeholder = "èŠå¤©ã€æŸ¥å¤©æ°”ï¼ˆåŒ—äº¬å¤©æ°”ï¼‰ã€è¦è¯­å½•ï¼ˆæ¯’é¸¡æ±¤ï¼‰ï¼Œæˆ–ç”¨åŠŸèƒ½èœå•...";

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            if (userInput) showMessage(userInput, false, "å¿ƒæ„å·²å¯„");
            const typingEl = showTyping();

            // åŠŸèƒ½åˆ†æµ
            let content = "";
            let meta = "";
            switch (inputData.type) {
                case "pixiv": content = await fetchPixiv(inputData.value); meta = "Pixivå›¾ç‰‡æœç´¢"; break;
                case "shengbei": content = await fetchShengbei(); meta = "æŠ•æ·åœ£æ¯"; break;
                case "lingqian": content = await fetchLingqian(); meta = "è¿åŠ¿çµç­¾"; break;
                case "taluo": content = await fetchTaluo(); meta = "å¡”ç½—ç‰Œå åœ"; break;
                case "daySign": content = await fetchDaySign(); meta = "ä»Šæ—¥æ—¥ç­¾"; break;
                case "weather": content = await fetchWeather(inputData.value); meta = "å¤©æ°”æŸ¥è¯¢"; break;
                case "quote": content = await fetchQuote(inputData.value); meta = "èšåˆè¯­å½•"; break;
                default: 
                    content = `${getTimeContext()} å’Œæˆ‘èŠèŠå§ï½ å¯ä»¥è¯´â€œæŸ¥å¤©æ°”â€â€œè¦è¯­å½•â€å“¦ï½`;
                    meta = "èŠå¤©å¯¹è¯";
            }

            // æ˜¾ç¤ºå›å¤
            chatMessages.removeChild(typingEl);
            showMessage(content, true, meta);
        }

        // ç»‘å®šäº‹ä»¶
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener("click", (e) => {
            if (!menuBtn.contains(e.target) && !functionMenu.contains(e.target)) {
                functionMenu.style.display = "none";
            }
        });
    </script>
</body>
</html>
