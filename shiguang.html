<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拾光絮语 | 多功能文艺聊天室</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Noto Serif SC", serif;
            letter-spacing: 0.3px;
        }

        body {
            background-color: #f5f7fa;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M3.414 1.414a2 2 0 112.828 0L10 6.586a2 2 0 11-2.828 2.828L3.414 4.242a2 2 0 010-2.828z' fill='%23d8dce3' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E"),
                linear-gradient(135deg, #f5f7fa 0%, #e4eaf5 100%);
            min-height: 100vh;
            padding: 2vw;
        }

        .chat-container {
            width: 90%;
            max-width: 780px;
            margin: 2vw auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            overflow: hidden;
            border: 1px solid rgba(224, 228, 235, 0.5);
        }

        /* 头部+功能菜单 */
        .chat-header {
            background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%);
            color: #fff;
            padding: 1vw 1.5vw;
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            position: relative;
        }
        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-title {
            font-family: "Ma Shan Zheng", cursive;
            font-weight: 400;
            font-size: clamp(1.5rem, 3vw, 24px);
            text-shadow: 1px 1px 2px rgba(100, 116, 139, 0.2);
            letter-spacing: 3px;
        }
        /* 功能菜单按钮 */
        .menu-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: clamp(12px, 1.5vw, 14px);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.3s ease;
        }
        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        /* 下拉菜单样式 */
        .function-menu {
            position: absolute;
            top: 100%;
            right: 1.5vw;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(165, 177, 194, 0.2);
            width: 220px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        .menu-category {
            padding: 8px 12px;
            background: #f1f5f9;
            color: #60a5fa;
            font-size: 13px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }
        .menu-item {
            padding: 10px 16px;
            color: #334155;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .menu-item:hover {
            background: #f8fafc;
        }
        .menu-item.active {
            background: #e6f0f5;
            color: #1e40af;
        }
        .menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 2px 0;
        }

        .chat-messages {
            height: clamp(300px, 55vh, 480px);
            padding: 2vw;
            overflow-y: auto;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h20v20H0V0zm2 2v16h16V2H2z' fill='%23e2e8f0' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .chat-messages::-webkit-scrollbar {
            width: 5px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.3);
            border-radius: 3px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
            transition: background 0.3s ease;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #7c8ba1;
        }

        .system-message {
            text-align: center;
            margin: 1.5vw 0;
            font-size: clamp(12px, 1.5vw, 13px);
            color: #7c8ba1;
        }
        .system-message span {
            background: rgba(226, 232, 240, 0.4);
            padding: 6px 16px;
            border-radius: 18px;
            border: 1px dashed rgba(148, 163, 184, 0.3);
            font-style: italic;
            letter-spacing: 0.5px;
        }

        .message {
            margin-bottom: 1.5vw;
            max-width: 72%;
            line-height: 1.7;
            transition: opacity 0.4s ease, transform 0.4s ease;
            opacity: 0;
            transform: translateY(10px) scale(0.98);
        }
        .message.left {
            margin-right: auto;
        }
        .message.right {
            margin-left: auto;
        }
        .message.show {
            opacity: 1;
            transform: translate(0, 0) scale(1);
        }

        .message-content {
            padding: clamp(12px, 2vw, 14px) clamp(18px, 2.5vw, 20px);
            border-radius: 20px;
            position: relative;
            box-shadow: 0 2px 8px rgba(165, 177, 194, 0.1);
            font-size: clamp(14px, 2vw, 15px);
            color: #334155;
        }

        .right .message-content {
            background: linear-gradient(145deg, #e4eaf5 0%, #d1d9e6 100%);
            border-bottom-right-radius: 5px;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='10' viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h10v10H0V0zm1 1v8h8V1H1z' fill='%23ffffff' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .left .message-content {
            background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
            border-bottom-left-radius: 5px;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='10' viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h10v10H0V0zm1 1v8h8V1H1z' fill='%23ffffff' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* 1. Pixiv图片搜索样式 */
        .pixiv-container {
            margin: 10px 0;
        }
        .pixiv-title {
            font-size: clamp(13px, 1.8vw, 14px);
            color: #60a5fa;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .pixiv-img {
            width: 100%;
            max-width: 90%;
            margin: 0 auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(165, 177, 194, 0.15);
            border: 1px solid rgba(224, 228, 235, 0.6);
        }
        .pixiv-tags {
            font-size: clamp(12px, 1.5vw, 13px);
            color: #7c8ba1;
            text-align: center;
            margin-top: 8px;
            line-height: 1.5;
        }

        /* 2. 投掷圣杯样式 */
        .shengbei-process {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(241, 245, 249, 0.6);
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
        }
        .shengbei-result {
            font-weight: 500;
            color: #1e40af;
            text-align: center;
            margin: 8px 0;
            font-size: 15px;
        }
        .shengbei-poem {
            font-style: italic;
            color: #60a5fa;
            text-align: center;
            line-height: 1.8;
            margin: 8px 0;
            padding: 8px;
            border-left: 2px solid #60a5fa;
        }

        /* 3. 运势灵签样式 */
        .lingqian-img {
            width: 100%;
            max-width: 80%;
            margin: 10px auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(165, 177, 194, 0.15);
        }
        .lingqian-text {
            line-height: 1.8;
            margin: 8px 0;
        }
        .lingqian-sign {
            color: #1e40af;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .lingqian-explain {
            margin-top: 8px;
            font-size: 14px;
            color: #334155;
        }

        /* 4. 塔罗牌样式 */
        .taluo-container {
            text-align: center;
            margin: 10px 0;
        }
        .taluo-img {
            width: 100%;
            max-width: 70%;
            margin: 0 auto;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(165, 177, 194, 0.15);
            border: 1px solid rgba(224, 228, 235, 0.6);
        }
        .taluo-name {
            font-size: 15px;
            color: #1e40af;
            margin: 8px 0;
            letter-spacing: 0.5px;
        }
        .taluo-keyword {
            font-size: 13px;
            color: #60a5fa;
            margin-bottom: 8px;
            font-style: italic;
        }
        .taluo-moral {
            line-height: 1.7;
            font-size: 14px;
            text-align: left;
            padding: 8px 12px;
            background: rgba(241, 245, 249, 0.6);
            border-radius: 8px;
        }

        /* 原有功能样式保留 */
        .day-sign-img {
            width: 100%;
            max-width: 80%;
            margin: 10px auto;
            display: block;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(165, 177, 194, 0.15);
            border: 1px solid rgba(224, 228, 235, 0.6);
        }
        .day-sign-tip {
            text-align: center;
            margin-bottom: 8px;
            color: #60a5fa;
            font-size: clamp(13px, 1.8vw, 14px);
            font-style: italic;
        }
        .quote-header {
            text-align: center;
            margin-bottom: 10px;
            color: #60a5fa;
            font-size: clamp(13px, 1.8vw, 14px);
            font-style: italic;
            letter-spacing: 1px;
        }
        .quote-content {
            line-height: 1.8;
            padding: 8px 12px;
            background: rgba(241, 245, 249, 0.6);
            border-radius: 8px;
            border-left: 2px solid #60a5fa;
            margin: 5px 0;
        }
        .quote-tip {
            text-align: center;
            margin-top: 8px;
            font-size: clamp(12px, 1.5vw, 13px);
            color: #7c8ba1;
        }
        .weather-message .message-content {
            background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
            border-left: 3px solid #60a5fa;
            color: #334155;
            padding: clamp(14px, 2.2vw, 16px) clamp(20px, 2.8vw, 22px);
        }
        .weather-item {
            display: block;
            margin: clamp(6px, 1.2vw, 8px) 0;
            font-size: clamp(13px, 1.8vw, 14px);
            line-height: 1.6;
        }
        .weather-item.api-key {
            font-weight: 500;
            color: #1e40af;
            padding-left: 4px;
            border-left: 2px solid #60a5fa;
        }
        .weather-item.api-aux {
            color: #334155;
            opacity: 1;
        }
        .weather-item span {
            font-weight: 500;
            color: #60a5fa;
            width: clamp(75px, 10vw, 85px);
            display: inline-block;
            letter-spacing: 0.8px;
        }
        .weather-item i {
            margin-right: 7px;
            font-size: clamp(14px, 1.8vw, 15px);
            vertical-align: middle;
            color: #60a5fa;
        }
        .weather-header {
            margin-bottom: clamp(6px, 1.2vw, 8px);
            font-size: clamp(15px, 2vw, 16px);
            color: #60a5fa;
            font-weight: 300;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        .weather-header .weather-icon {
            margin-right: clamp(6px, 1vw, 8px);
            font-size: clamp(16px, 2.2vw, 18px);
        }

        .message-time {
            font-size: clamp(10px, 1.2vw, 11px);
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
            font-style: italic;
            letter-spacing: 0;
            color: #7c8ba1;
        }
        .left .message-time {
            padding-left: 16px;
        }
        .right .message-time {
            padding-right: 16px;
        }
        .message-meta {
            font-size: clamp(9px, 1vw, 10px);
            margin-top: 2px;
            opacity: 0;
            text-align: right;
            font-style: italic;
            transition: opacity 0.6s ease 0.2s;
            color: #7c8ba1;
        }
        .message.show .message-meta {
            opacity: 0.5;
        }

        /* 输入区+功能触发提示 */
        .chat-input-area {
            padding: 1vw 1.5vw;
            border-top: 1px solid rgba(224, 228, 235, 0.6);
            background: rgba(255, 255, 255, 0.98);
        }
        .input-tip {
            font-size: clamp(11px, 1.2vw, 12px);
            color: #a5b4c7;
            margin-bottom: 10px;
            text-align: left;
            letter-spacing: 0.3px;
        }
        .chat-input {
            display: flex;
            gap: 12px;
        }
        #message-input {
            flex: 1;
            padding: clamp(12px, 1.8vw, 14px) clamp(18px, 2.2vw, 20px);
            border: 1px solid #e2e8f0;
            border-radius: 28px;
            outline: none;
            font-size: clamp(14px, 2vw, 15px);
            color: #334155;
            background: rgba(248, 250, 252, 0.8);
            transition: all 0.3s ease;
            box-shadow: inset 0 1px 3px rgba(165, 177, 194, 0.05);
        }
        #message-input:focus {
            border-color: #94a3b8;
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.15), inset 0 1px 3px rgba(165, 177, 194, 0.05);
            background: #fff;
        }
        #message-input::placeholder {
            color: #a5b4c7;
            font-style: italic;
            letter-spacing: 0.5px;
        }

        #send-btn {
            padding: clamp(12px, 1.8vw, 14px) clamp(22px, 2.5vw, 28px);
            border: none;
            border-radius: 28px;
            background: linear-gradient(145deg, #6a85b6 0%, #8a9fc2 100%);
            color: #fff;
            font-family: "Ma Shan Zheng", cursive;
            font-size: clamp(14px, 2vw, 15px);
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            white-space: nowrap;
        }
        #send-btn:hover {
            background: linear-gradient(145deg, #5a75a6 0%, #7a8fba 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(106, 133, 182, 0.3);
        }
        #send-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(106, 133, 182, 0.2);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: clamp(8px, 1.5vw, 10px) clamp(12px, 2vw, 16px);
            background: linear-gradient(145deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            width: fit-content;
            box-shadow: 0 2px 8px rgba(165, 177, 194, 0.1);
        }
        .typing-indicator span {
            width: clamp(8px, 1.2vw, 9px);
            height: clamp(8px, 1.2vw, 9px);
            border-radius: 50%;
            background: #94a3b8;
            animation: typing 1.5s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 0.8; }
        }

        /* 移动端适配 */
        @media (max-width: 480px) {
            .message {
                max-width: 85%;
            }
            .function-menu {
                width: 180px;
                right: 1vw;
            }
            .menu-item {
                padding: 8px 12px;
                font-size: 13px;
            }
            .pixiv-img, .taluo-img, .lingqian-img, .day-sign-img {
                max-width: 95%;
            }
            .weather-item span {
                width: 65px;
            }
            .chat-input {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- 头部+功能菜单 -->
        <div class="chat-header">
            <div class="header-inner">
                <div class="chat-title">拾光絮语</div>
                <button class="menu-btn" id="menu-btn">
                    <span>功能菜单</span>
                    <span>▼</span>
                </button>
            </div>
            <!-- 功能菜单下拉框 -->
            <div class="function-menu" id="function-menu">
                <div class="menu-category">日常互动</div>
                <div class="menu-item" data-function="chat">聊天对话</div>
                <div class="menu-item" data-function="weather">天气查询</div>
                <div class="menu-divider"></div>
                <div class="menu-category">文艺内容</div>
                <div class="menu-item" data-function="day-sign">今日日签</div>
                <div class="menu-item" data-function="quote">聚合语录</div>
                <div class="menu-item" data-function="pixiv">Pixiv图片搜索</div>
                <div class="menu-divider"></div>
                <div class="menu-category">运势占卜</div>
                <div class="menu-item" data-function="shengbei">投掷圣杯</div>
                <div class="menu-item" data-function="lingqian">运势灵签</div>
                <div class="menu-item" data-function="taluo">塔罗牌占卜</div>
            </div>
        </div>

        <!-- 消息区 -->
        <div class="chat-messages" id="chat-messages">
            <div class="system-message">
                <span>二零二五年春 · 我们在此相遇</span>
            </div>
            <div class="message left show">
                <div class="message-content">
                    你好呀～ 点击右上角「功能菜单」可快速使用功能，也能输入关键词（例：查北京天气/要毒鸡汤/掷圣杯）
                </div>
                <div class="message-time">14:25</div>
                <div class="message-meta">絮语38字 · 心意6字</div>
            </div>
        </div>

        <!-- 输入区 -->
        <div class="chat-input-area">
            <div class="input-tip">提示：输入“搜Pixiv+关键词”“抽灵签”“抽塔罗牌”等可快速触发功能</div>
            <div class="chat-input">
                <input type="text" id="message-input" placeholder="聊天、查天气（北京天气）、要语录（毒鸡汤），或用功能菜单...">
                <button id="send-btn">送信</button>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const menuBtn = document.getElementById('menu-btn');
        const functionMenu = document.getElementById('function-menu');
        const menuItems = document.querySelectorAll('.menu-item');

        // 接口配置（新增4个API+原有API）
        const API_CONFIG = {
            pixiv: "http://ranyu.sbs/API/pz.php",        // Pixiv图片搜索
            shengbei: "http://ranyu.sbs/API/shengbei.php", // 投掷圣杯
            lingqian: "http://ranyu.sbs/API/lingqian.php", // 运势灵签
            taluo: "http://ranyu.sbs/API/taluo.php",     // 塔罗牌
            daySign: "http://api.xingchenfu.xyz/API/day.php", // 日签
            weather: "https://api.icofun.cn/api/xztq.php", // 天气
            quote: "https://api.icofun.cn/api/zpai.php"    // 聚合语录
        };
        const IMG_TEXT_TO_REMOVE = "±img=https://s1.sencdn.com/web/icons/black/[0-9]+@1x.png±";
        let currentFunction = null; // 当前选中功能

        // 基础工具函数
        function getTimeContext() {
            const hour = new Date().getHours();
            const contexts = [
                [6,10,"晨雾轻轻漫过窗沿时"],
                [10,12,"阳光悄悄跳上桌面时"],
                [12,15,"风携着暖意拂过肩头时"],
                [15,18,"晚霞把天际染成粉橘色时"],
                [18,21,"灯影慢慢漫过街角时"],
                [21,24,"星子缀满墨色夜空时"],
                [0,6,"月色静静浸着房间时"]
            ];
            return contexts.find(([s, e, ctx]) => hour >= s && hour < e)[2];
        }

        function showTyping() {
            const typingEl = document.createElement("div");
            typingEl.className = "message left typing-indicator";
            typingEl.innerHTML = "<span></span><span></span><span></span>";
            chatMessages.appendChild(typingEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingEl;
        }

        function showMessage(content, isLeft = true, meta = "消息") {
            const timeStr = new Date().toTimeString().slice(0, 5);
            const msgEl = document.createElement("div");
            msgEl.className = `message ${isLeft ? "left" : "right"}`;
            msgEl.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${timeStr}</div>
                <div class="message-meta">${meta}</div>
            `;
            chatMessages.appendChild(msgEl);
            setTimeout(() => msgEl.classList.add("show"), 50);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return msgEl;
        }

        // --------------------------
        // 1. 新增：Pixiv图片搜索（API id=35）
        // --------------------------
        function parsePixivQuery(userMsg) {
            const match = userMsg.match(/搜Pixiv([^，。\s]+)/);
            return match ? match[1].trim() : null;
        }

        async function fetchPixiv(keyword) {
            if (!keyword) {
                return `
                    <div class="pixiv-title">${getTimeContext()} · Pixiv搜索提示</div>
                    <div style="text-align:center; margin-top:8px;">请告诉我要搜索的关键词哦～ 例：搜Pixiv天气之子</div>
                `;
            }

            try {
                const params = new URLSearchParams({ q: keyword, type: "all" });
                const res = await fetch(`${API_CONFIG.pixiv}?${params.toString()}`);
                const data = await res.json();

                if (data.code !== "200" || !data.data || data.data.length === 0) {
                    throw new Error("没找到相关图片，换个关键词试试吧～");
                }

                const firstImg = data.data[0];
                return `
                    <div class="pixiv-container">
                        <div class="pixiv-title">${getTimeContext()} · Pixiv搜索结果（${keyword}）</div>
                        <img src="${firstImg.img2 || firstImg.img1}" class="pixiv-img" 
                             alt="${firstImg.title}"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzgwODA4MCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHRleHQ9Ik1JR04g5Zu+5Lq65paw5pyN5Yqh54K5Ii8+PC9zdmc+'">
                        <div class="pixiv-tags">标题：${firstImg.title || "未命名"} | 标签：${firstImg.tags || "无"}</div>
                    </div>
                `;
            } catch (err) {
                return `
                    <div class="pixiv-title">${getTimeContext()} · Pixiv搜索提示</div>
                    <div style="text-align:center; margin-top:8px;">${err.message}</div>
                `;
            }
        }

        // --------------------------
        // 2. 新增：投掷圣杯（API id=40）
        // --------------------------
        async function fetchShengbei() {
            try {
                const res = await fetch(API_CONFIG.shengbei);
                const data = await res.json();

                if (data.code !== "200") {
                    throw new Error("圣杯投掷失败，稍等再试吧～");
                }

                return `
                    <div class="shengbei-process">
                        ${getTimeContext()} · 圣杯投掷过程：<br>
                        ${data.process.map((step, idx) => `${idx+1}. ${step}`).join("<br>")}
                    </div>
                    <div class="shengbei-result">投掷结果：${data.result}</div>
                    <div class="shengbei-poem">签诗：${data.poem || "无"}</div>
                    <div style="text-align:center; font-size:13px; color:#7c8ba1;">
                        解曰：${data.content || "暂无解签内容"}
                    </div>
                `;
            } catch (err) {
                return `
                    <div class="shengbei-result">${getTimeContext()} · 圣杯提示</div>
                    <div style="text-align:center; margin-top:8px;">${err.message}</div>
                `;
            }
        }

        // --------------------------
        // 3. 新增：运势灵签（API id=14）
        // --------------------------
        async function fetchLingqian() {
            try {
                // 先尝试获取图片格式，失败则用文本
                let res = await fetch(`${API_CONFIG.lingqian}?type=img`);
                if (res.ok && res.headers.get("content-type").includes("image")) {
                    const blob = await res.blob();
                    const imgUrl = URL.createObjectURL(blob);
                    return `
                        <div class="lingqian-title">${getTimeContext()} · 今日灵签</div>
                        <img src="${imgUrl}" class="lingqian-img" alt="运势灵签"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzgwODA4MCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHRleHQ9Iui9veWbvSIsIHN0cm9rZT0iIzYwYTVmYSIvPjwvc3ZnPg=='">
                    `;
                }

                // 文本格式
                res = await fetch(API_CONFIG.lingqian);
                const text = await res.text();
                const signMatch = text.match(/第\d+签【([^】]+)】/);
                const poemMatch = text.match(/签诗:(.+?)(解签:|$)/s);
                const explainMatch = text.match(/解签:(.+?)(解曰:|$)/s);
                const jieYueMatch = text.match(/解曰:(.+)/s);

                return `
                    <div class="lingqian-text">
                        <div class="lingqian-sign">${getTimeContext()} · 运势灵签 ${signMatch ? signMatch[0] : ""}</div>
                        <div>签诗：${poemMatch ? poemMatch[1].trim() : "无"}</div>
                        <div class="lingqian-explain">解签：${explainMatch ? explainMatch[1].trim() : "无"}</div>
                        <div class="lingqian-explain">解曰：${jieYueMatch ? jieYueMatch[1].trim() : "无"}</div>
                    </div>
                `;
            } catch (err) {
                return `
                    <div class="lingqian-sign">${getTimeContext()} · 灵签提示</div>
                    <div style="text-align:center; margin-top:8px;">灵签获取失败，稍等再试吧～</div>
                `;
            }
        }

        // --------------------------
        // 4. 新增：塔罗牌（API id=1）
        // --------------------------
        async function fetchTaluo() {
            try {
                const res = await fetch(API_CONFIG.taluo);
                const data = await res.json();

                if (!data.name || !data.image) {
                    throw new Error("塔罗牌获取失败，换个时间试试吧～");
                }

                return `
                    <div class="taluo-container">
                        <div class="taluo-name">${getTimeContext()} · 塔罗牌：${data.name}</div>
                        <img src="${data.image}" class="taluo-img" alt="${data.name}"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzgwODA4MCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHRleHQ9IlRhbHVvIFBhcmtpbmcg55S75Lq65paw5pyN5Yqh54K5Ii8+PC9zdmc+'">
                        <div class="taluo-keyword">关键词：${data.keyword || "无"}</div>
                        <div class="taluo-moral">寓意：${data.moral || "暂无寓意解释"}</div>
                    </div>
                `;
            } catch (err) {
                return `
                    <div class="taluo-name">${getTimeContext()} · 塔罗牌提示</div>
                    <div style="text-align:center; margin-top:8px;">${err.message}</div>
                `;
            }
        }

        // --------------------------
        // 原有功能保留（日签/天气/聚合语录）
        // --------------------------
        async function fetchDaySign() {
            try {
                const res = await fetch(API_CONFIG.daySign);
                if (!res.ok) throw new Error("日签获取失败");
                const blob = await res.blob();
                const imgUrl = URL.createObjectURL(blob);
                return `
                    <div class="day-sign-tip">${getTimeContext()} 今日日签</div>
                    <img src="${imgUrl}" class="day-sign-img" alt="今日日签"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzgwODA4MCIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHRleHQ9IkfmmoLmmoLvvIwveiLseS6huiuseWbvSIsIHN0cm9rZT0iIzYwYTVmYSIvPjwvc3ZnPg=='">
                `;
            } catch (err) {
                return `
                    <div class="day-sign-tip">${getTimeContext()} 日签提示</div>
                    <div style="text-align:center; margin-top:8px;">日签暂时拿不到，换个时间试试吧～</div>
                `;
            }
        }

        async function fetchWeather(city) {
            if (!city) return `
                <div class="weather-header"><span class="weather-icon">⚠️</span>${getTimeContext()} 天气提示</div>
                <div class="weather-item api-aux"><span>请输入地名</span>： <<<i>💡</</</i> 例：北京天气、上海天气</div>
            `;

            try {
                const params = new URLSearchParams({ msg: city, hh: "\n" });
                const res = await fetch(`${API_CONFIG.weather}?${params.toString()}`);
                let text = await res.text().replace(new RegExp(IMG_TEXT_TO_REMOVE, "g"), "").trim();
                if (!text) throw new Error("无天气数据");

                const data = {};
                text.split("\n").forEach(line => {
                    const [k, v] = line.split("：").map(i => i.trim());
                    if (k && v) data[k] = v;
                });

                const weatherMap = { "晴":"☀️", "多云":"☁️", "阴":"🌥️", "雨":"🌧️", "雪":"❄️" };
                const icon = weatherMap[data["实时天气"]?.slice(0,1)] || "🌤️";
                const temp = data["实时气温"] ? data["实时气温"].replace("°", "℃") : "未知";

                return `
                    <div class="weather-header"><span class="weather-icon">${icon}</span>${getTimeContext()} ${data["城市名"] || city}天气</div>
                    <div class="weather-item api-key"><span>实时天气</span>： <<<i>${icon}</</</i> ${data["实时天气"] || "未知"}</div>
                    <div class="weather-item api-key"><span>实时气温</span>： <<<i>🌡️</</</i> ${temp}</div>
                    <div class="weather-item api-aux"><span>更新时间</span>： <<<i>⏰</</</i> ${data["更新时间"] || "未知"}</div>
                `;
            } catch (err) {
                return `
                    <div class="weather-header"><span class="weather-icon">⚠️</span>${getTimeContext()} 天气提示</div>
                    <div class="weather-item api-aux"><span>查询地名</span>： <<<i>📍</</</i> ${city}</div>
                    <div class="weather-item api-aux"><span>状态</span>： <<<i>❌</</i> 暂未获取到天气数据</div>
                `;
            }
        }

        async function fetchQuote(type) {
            const quoteTypes = ["毒鸡汤", "情话", "笑话", "安慰语录"];
            const targetType = type || quoteTypes[Math.floor(Math.random() * quoteTypes.length)];
            try {
                const params = new URLSearchParams({ msg: targetType, type: "text" });
                const res = await fetch(`${API_CONFIG.quote}?${params.toString()}`);
                const text = await res.text().trim();
                return `
                    <div class="quote-header">${getTimeContext()} · 今日份${targetType}</div>
                    <div class="quote-content">${text || "暂无语录内容"}</div>
                    <div class="quote-tip">—— 来自聚合语录</div>
                `;
            } catch (err) {
                return `
                    <div class="quote-header">${getTimeContext()} · 语录提示</div>
                    <div class="quote-content" style="text-align:center;">${targetType}暂时拿不到，换个类型试试～</div>
                `;
            }
        }

        // --------------------------
        // 功能触发与菜单交互
        // --------------------------
        // 菜单展开/收起
        menuBtn.addEventListener("click", () => {
            functionMenu.style.display = functionMenu.style.display === "block" ? "none" : "block";
        });

        // 点击菜单触发功能
        menuItems.forEach(item => {
            item.addEventListener("click", () => {
                currentFunction = item.dataset.function;
                item.classList.add("active");
                setTimeout(() => item.classList.remove("active"), 300);
                functionMenu.style.display = "none";

                // 特殊处理需要输入的功能（Pixiv）
                if (currentFunction === "pixiv") {
                    messageInput.placeholder = "请输入Pixiv搜索关键词（例：天气之子）...";
                    messageInput.focus();
                } else {
                    sendMessage();
                }
            });
        });

        // 关键词解析
        function parseUserInput(input) {
            input = input.trim();
            if (input.includes("Pixiv")) return { type: "pixiv", value: parsePixivQuery(input) };
            if (input.includes("圣杯")) return { type: "shengbei" };
            if (input.includes("灵签")) return { type: "lingqian" };
            if (input.includes("塔罗")) return { type: "taluo" };
            if (input.includes("日签")) return { type: "daySign" };
            if (input.includes("天气")) return { type: "weather", value: input.replace(/天气|查|的/g, "").trim() };
            if (["毒鸡汤", "情话", "笑话", "安慰"].some(t => input.includes(t))) return { type: "quote", value: input };
            return { type: "chat", value: input };
        }

        // 统一发送逻辑
        async function sendMessage() {
            const userInput = messageInput.value.trim() || "";
            const inputData = currentFunction ? { type: currentFunction, value: userInput } : parseUserInput(userInput);
            currentFunction = null;
            messageInput.value = "";
            messageInput.placeholder = "聊天、查天气（北京天气）、要语录（毒鸡汤），或用功能菜单...";

            // 显示用户消息
            if (userInput) showMessage(userInput, false, "心意已寄");
            const typingEl = showTyping();

            // 功能分流
            let content = "";
            let meta = "";
            switch (inputData.type) {
                case "pixiv": content = await fetchPixiv(inputData.value); meta = "Pixiv图片搜索"; break;
                case "shengbei": content = await fetchShengbei(); meta = "投掷圣杯"; break;
                case "lingqian": content = await fetchLingqian(); meta = "运势灵签"; break;
                case "taluo": content = await fetchTaluo(); meta = "塔罗牌占卜"; break;
                case "daySign": content = await fetchDaySign(); meta = "今日日签"; break;
                case "weather": content = await fetchWeather(inputData.value); meta = "天气查询"; break;
                case "quote": content = await fetchQuote(inputData.value); meta = "聚合语录"; break;
                default: 
                    content = `${getTimeContext()} 和我聊聊吧～ 可以说“查天气”“要语录”哦～`;
                    meta = "聊天对话";
            }

            // 显示回复
            chatMessages.removeChild(typingEl);
            showMessage(content, true, meta);
        }

        // 绑定事件
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 点击页面其他地方关闭菜单
        document.addEventListener("click", (e) => {
            if (!menuBtn.contains(e.target) && !functionMenu.contains(e.target)) {
                functionMenu.style.display = "none";
            }
        });
    </script>
</body>
</html>
